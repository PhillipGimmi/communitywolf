// src/lib/tools/web-search.ts

export interface WebSearchResult {
  title: string;
  url: string;
  snippet: string;
  source?: string;
}

export interface WebSearchResponse {
  results: WebSearchResult[];
  totalResults: number;
  searchTime: number;
}

/**
 * Web search tool using SerpAPI for finding crime and safety news
 */
export async function performWebSearch(query: string): Promise<WebSearchResponse> {
  const startTime = Date.now();
  
  try {
    const serpApiKey = process.env.SERPAPI_KEY;
    if (!serpApiKey) {
      throw new Error('SERPAPI_KEY environment variable is not set');
    }

    const results = await searchWithSerpAPI(query, serpApiKey);
    
    return {
      results: results,
      totalResults: results.length,
      searchTime: Date.now() - startTime
    };
  } catch (error) {
    console.error('Web search failed:', error);
    throw new Error('Failed to perform web search');
  }
}

/**
 * Search using SerpAPI
 */
async function searchWithSerpAPI(query: string, apiKey: string): Promise<WebSearchResult[]> {
  const baseUrl = 'https://serpapi.com/search.json';
  const params = new URLSearchParams({
    q: query,
    api_key: apiKey,
    engine: 'google',
    num: '10', // Number of results
    gl: 'za', // Country (South Africa)
    hl: 'en'  // Language
  });

  const response = await fetch(`${baseUrl}?${params}`);
  
  if (!response.ok) {
    throw new Error(`SerpAPI request failed: ${response.status} ${response.statusText}`);
  }

  const data = await response.json();
  
  if (data.error) {
    throw new Error(`SerpAPI error: ${data.error}`);
  }

  // Extract results from SerpAPI response
  const results: WebSearchResult[] = [];
  
  if (data.organic_results) {
    for (const result of data.organic_results) {
      results.push({
        title: result.title || 'No title',
        url: result.link || '',
        snippet: result.snippet || 'No description available',
        source: result.source || 'Unknown source'
      });
    }
  }

  return results;
}